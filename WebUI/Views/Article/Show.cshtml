@model Article
@{
    var commentModel = new CreateCommentViewModel();
}

<style>
    .comment-item:last-child {
        margin-bottom: 0 !important;
    }

    .widget-comments {
        margin-bottom: 0 !important;
    }

    .field-validation-error {
        color: #F67280;
        font-size: .8rem;
        padding: 10px 20px 0 20px;
    }

    .user-avatar {
        width: 80px;
        height: 80px;
        overflow: hidden;
        border-radius: 50%;
        margin-left: 20px;
    }

        .user-avatar img {
            width: 100%;
            object-fit: cover;
            margin: 0 !important;
        }

    .reply-comment-item {
        padding-right: 80px;
    }

    .d-none {
        display: none !important;
    }
</style>

<section class="section pt-55 ">
    <div class="container-fluid">
        <div class="row">
            <div class="col-lg-8 mb-20">
                <!--Post-single-->
                <div class="post-single">
                    <div class="post-single-image">
                        <img src="~/images/articles/@Model.ImageName" alt="@Model.Title">
                    </div>
                    <div class="post-single-content">
                        <h4>@Model.Title</h4>
                        <div class="post-single-info">
                            <ul class="list-inline">
                                @if (Model.User.ImageName != null)
                                {
                                    <li>
                                        <a asp-controller="Author"
                                       asp-action="Index"
                                       asp-route-authorId="@Model.User.UserId">
                                            <img src="~/images/users/@Model.User.ImageName"
                                             alt="@(Model.User.FirstName+" "+Model.User.LastName)">
                                        </a>
                                    </li>
                                }
                                <li>
                                    <a asp-controller="Author"
                                       asp-action="Index"
                                       asp-route-authorId="@Model.User.UserId">@(Model.User.FirstName + " " + Model.User.LastName)</a>
                                </li>
                                <li class="dot"></li>
                                <li>@Model.CreateDate.ToShamsi()</li>
                                <li class="dot"></li>
                                <li>3 دیدگاه</li>
                            </ul>
                        </div>
                    </div>

                    <div class="post-single-body">
                        @Html.Raw(Model.Text)
                    </div>

                    <div class="post-single-footer">
                        @if (Model.Tags != null)
                        {
                            <div class="tags">
                                <ul class="list-inline">
                                    @foreach (var tag in Model.Tags.Split("-"))
                                    {
                                        <li>
                                            <a asp-controller="Home"
                                       asp-action="Search"
                                       asp-route-filter="@tag">@tag</a>
                                        </li>
                                    }
                                </ul>
                            </div>
                        }
                    </div>
                </div>
                <!--/-->
                <!--widget-comments-->
                <div class="widget mb-50">

                    @if (User.Identity.IsAuthenticated)
                    {
                        ViewData["ArticleId"] = Model.ArticleId;
                        ViewData["UserId"] = User.Identity.Name;
                        <partial name="_CommentPartial" model=commentModel view-data="ViewData" />
                    }
                    else
                    {
                        <div class="alert alert-info">
                            برای نوشتن دیدگاه خود ابتدا <a asp-controller="Account"
                                                       asp-action="Login"
                                                       asp-route-returnUrl="@Context.Request.Path">وارد شوید</a>
                            <br />
                            در صورتی که حساب کاربری ندارید ابتدا <a asp-controller="Account"
                                                                asp-action="Register"
                                                                asp-route-returnUrl="@Context.Request.Path">ثبت نام کنید</a>
                        </div>
                    }

                    @if (Model.Comments.Count > 0)
                    {
                        <div class="title">
                            <h5>@Model.Comments.Where(c => c.ParentId == null).Count() دیدگاه</h5>
                        </div>
                        <ul class="widget-comments">
                            @foreach (var comment in Model.Comments
                           .Where(c => c.ParentId == null)
                           .OrderByDescending(c => c.CreateDate))
                            {
                                <li class="comment-item">
                                    @if (comment.User.ImageName != null)
                                    {
                                        <div class="user-avatar">
                                            <img src="~/images/users/@comment.User.ImageName"
                                     alt="@(comment.User.FirstName+" "+comment.User.LastName)">
                                        </div>
                                    }
                                    <div class="content">
                                        <ul class="info list-inline">
                                            <li>@(comment.User.FirstName + " " + comment.User.LastName)</li>
                                            <li class="dot"></li>
                                            <li>@comment.CreateDate.ToShamsi()</li>
                                        </ul>
                                        @Html.Raw(comment.Text)
                                        @if (User.Identity.IsAuthenticated)
                                        {
                                            if (comment.UserId == Guid.Parse(User.Identity.Name))
                                            {
                                                <div class="mb-1">
                                                    <a href="javascript:void(0)"
                                       onclick="editComment(this)"
                                       class="link">
                                                        <span class="d-none comment-id">@comment.CommentId</span>
                                                        <span class="d-none text">@comment.Text</span>
                                                        ویرایش
                                                    </a>
                                                    <a href="javascript:void(0)"
                                       onclick="deleteComment(this)"
                                       class="link">
                                                        <span class="d-none comment-id">@comment.CommentId</span>
                                                        حذف
                                                    </a>
                                                </div>
                                            }


                                            <div>
                                                <a href="javascript:void(0)"
                                       onclick="sendReply(this)"
                                       class="link">
                                                    <span class="d-none article-id">@Model.ArticleId</span>
                                                    <span class="d-none parent-id">@comment.CommentId</span>
                                                    <i class="arrow_back"></i> پاسخ
                                                </a>
                                            </div>
                                        }
                                    </div>
                                </li>

                                @if (Model.Comments.Any(c => c.ParentId != null && c.ParentId == comment.CommentId))
                                {
                                    @foreach (var reply in Model.Comments
                                   .Where(c => c.ParentId != null && c.ParentId == comment.CommentId)
                                   .OrderByDescending(c => c.CreateDate))
                                    {
                                        <li class="comment-item reply-comment-item">
                                            @if (reply.User.ImageName != null)
                                            {
                                                <div class="user-avatar">
                                                    <img src="~/images/users/@reply.User.ImageName"
                                     alt="@(reply.User.FirstName+" "+reply.User.LastName)">
                                                </div>
                                            }
                                            <div class="content">
                                                <ul class="info list-inline">
                                                    <li>@(reply.User.FirstName + " " + reply.User.LastName)</li>
                                                    <li class="dot"></li>
                                                    <li>@reply.CreateDate.ToShamsi()</li>
                                                </ul>
                                                @Html.Raw(reply.Text)
                                                @if (User.Identity.IsAuthenticated)
                                                {
                                                    if (reply.UserId == Guid.Parse(User.Identity.Name))
                                                    {
                                                        <div class="mb-1">
                                                            <a href="javascript:void(0)"
                                       onclick="editComment(this)"
                                       class="link">
                                                                <span class="d-none comment-id">@reply.CommentId</span>
                                                                <span class="d-none parent-id">@reply.ParentId</span>
                                                                <span class="d-none text">@reply.Text</span>
                                                                ویرایش
                                                            </a>
                                                            <a href="javascript:void(0)"
                                       onclick="deleteComment(this)"
                                       class="link">
                                                                <span class="d-none comment-id">@reply.CommentId</span>
                                                                حذف
                                                            </a>
                                                        </div>
                                                    }
                                                }
                                            </div>
                                        </li>
                                    }
                                }
                            }
                        </ul>
                    }
                    else
                    {
                        <div class="alert alert-info">
                            هیچ دیدگاهی وجود ندارد
                            <br />
                            شما اولین نفر باشید
                        </div>
                    }
                </div>
            </div>
            <div class="col-lg-4 max-width">
                <!--widget-author-->
                <div class="widget">
                    <div class="widget-author">
                        @if (Model.User.ImageName != null)
                        {
                            <a asp-controller="Author"
                           asp-action="Index"
                           asp-route-authorId="@Model.User.UserId" class="image">
                                <img src="~/images/users/@Model.User.ImageName"
                                 alt="@(Model.User.FirstName+" "+Model.User.LastName)">
                            </a>
                        }
                        <h6>
                            <span>@(Model.User.FirstName + " " + Model.User.LastName)</span>
                        </h6>
                        @if (Model.User.Email != null)
                        {
                            <p>@Model.User.Email</p>
                        }
                        @*@if (Model.User.Description != null)
                        {
                        <div class="user-description">
                        @Html.Raw(Model.User.Description)
                        </div>
                        }*@
                        @*<div class="social-media">
                        <ul class="list-inline">
                        <li>
                        <a href="#" class="color-facebook">
                        <i class="fab fa-facebook"></i>
                        </a>
                        </li>
                        <li>
                        <a href="#" class="color-instagram">
                        <i class="fab fa-instagram"></i>
                        </a>
                        </li>
                        <li>
                        <a href="#" class="color-twitter">
                        <i class="fab fa-twitter"></i>
                        </a>
                        </li>
                        <li>
                        <a href="#" class="color-youtube">
                        <i class="fab fa-youtube"></i>
                        </a>
                        </li>
                        <li>
                        <a href="#" class="color-pinterest">
                        <i class="fab fa-pinterest"></i>
                        </a>
                        </li>
                        </ul>
                        </div>*@
                    </div>
                </div>
                @await Component.InvokeAsync("LatestArticlesComponent")
                @await Component.InvokeAsync("TagsComponent")
                <!--/-->
            </div>
        </div>
    </div>
</section>


@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
        await Html.RenderPartialAsync("_ChangeImageScriptPartial");
    }
    <script src="~/assets/js/ckeditor.min.js"></script>
    <script src="~/assets/js/translations/fa.min.js"></script>
    <script>
        ClassicEditor.create(document.querySelector("#CommentText"), {
            language: 'fa'
        });
    </script>
    <script>
        const sendReply = (t) => {
            var articleId = $(t).children('.article-id').html();
            var parentId = $(t).children('.parent-id').html();
            Swal.fire({
                title: 'متن پاسخ را وارد کنید',
                html: `<form id="replyCommentForm" method="post" action="/Article/CreateCommentReply">` +
                    `<input type="hidden" name="articleId" value="${articleId}"/>` +
                    `<input type="hidden" name="parentId" value="${parentId}"/>` +
                    `<textarea id="replyText" class="swal2-textarea" name="text"></textarea>` +
                    `</form>`,
                showConfirmButton: true,
                showCloseButton: true,
                showCancelButton: true,
                confirmButtonText: 'ارسال',
                confirmButtonColor: 'green',
                cancelButtonText: 'انصراف',
            })
                .then(result => {
                    if (result.isConfirmed) {
                        $("#replyCommentForm").submit();
                    }
                });

            ClassicEditor.create(document.querySelector("#replyText"), {
                language: 'fa'
            });
        }

        const editComment = (t) => {
            var commentId = $(t).children('.comment-id').html();
            var parentId = $(t).children('.parent-id').html();
            var text = $(t).children('.text').html();
            Swal.fire({
                title: 'متن دیدگاه خود را ویرایش کنید',
                html: `<form id="editCommentForm" method="post" action="/Article/EditComment">` +
                    `<input type="hidden" name="commentId" value="${commentId}"/>` +
                    `<input type="hidden" name="parentId" value="${parentId}"/>` +
                    `<textarea id="editCommentText" class="swal2-textarea" name="text">${text}</textarea>` +
                    `</form>`,
                showConfirmButton: true,
                showCloseButton: true,
                showCancelButton: true,
                confirmButtonText: 'ویرایش',
                confirmButtonColor: 'gold',
                cancelButtonText: 'انصراف',
            })
                .then(result => {
                    if (result.isConfirmed) {
                        $("#editCommentForm").submit();
                    }
                });

            ClassicEditor.create(document.querySelector("#editCommentText"), {
                language: 'fa'
            });
        }

        const deleteComment = (t) => {
            var commentId = $(t).children('.comment-id').html();
            Swal.fire({
                icon: 'warning',
                title: 'آیا از  حذف این دیدگاه مطمئن هستید؟',
                html: `<form id="deleteCommentForm" method="post" action="/Article/DeleteComment">` +
                    `<input type="hidden" name="commentId" value="${commentId}"/>` +
                    `</form>`,
                showConfirmButton: true,
                showCloseButton: true,
                showCancelButton: true,
                confirmButtonText: 'حذف',
                confirmButtonColor: 'red',
                cancelButtonText: 'انصراف',
            })
                .then(result => {
                    if (result.isConfirmed) {
                        $("#deleteCommentForm").submit();
                    }
                });
        }
    </script>
}